<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width,initial-scale=1,viewport-fit=cover"
  />
  <title>Little Typist ABC</title>

  <!-- Built-in favicon (no extra files needed) -->
  <link
    rel="icon"
    href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 128 128'%3E%3Cdefs%3E%3CradialGradient id='g' cx='30%25' cy='30%25' r='80%25'%3E%3Cstop offset='0' stop-color='%2300e5ff'/%3E%3Cstop offset='0.5' stop-color='%235a2bff'/%3E%3Cstop offset='1' stop-color='%2300ff9a'/%3E%3C/radialGradient%3E%3C/defs%3E%3Crect x='10' y='10' width='108' height='108' rx='26' fill='url(%23g)'/%3E%3Ctext x='64' y='78' text-anchor='middle' font-family='Arial, sans-serif' font-size='56' font-weight='900' fill='white'%3EABC%3C/text%3E%3C/svg%3E"
  />
  <link
    rel="apple-touch-icon"
    href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 180 180'%3E%3Cdefs%3E%3CradialGradient id='g' cx='30%25' cy='30%25' r='80%25'%3E%3Cstop offset='0' stop-color='%2300e5ff'/%3E%3Cstop offset='0.5' stop-color='%235a2bff'/%3E%3Cstop offset='1' stop-color='%2300ff9a'/%3E%3C/radialGradient%3E%3C/defs%3E%3Crect x='18' y='18' width='144' height='144' rx='34' fill='url(%23g)'/%3E%3Ctext x='90' y='110' text-anchor='middle' font-family='Arial, sans-serif' font-size='70' font-weight='900' fill='white'%3EABC%3C/text%3E%3C/svg%3E"
  />

  <style>
    :root{
      --ink:#0b1020;

      /* Light (used when toggled) */
      --bg1:#ff7aa2;
      --bg2:#7afcff;
      --bg3:#fff07a;
      --bg4:#a7ff7a;
      --card:#ffffffde;
      --key:#ffffffcc;
      --keyShadow: 0 10px 18px rgba(0,0,0,.10);
      --shadow: 0 16px 45px rgba(0,0,0,.18);
      --keyPressed:#ffe06a;
      --muted:#0b1020cc;

      --gridA: rgba(0,0,0,.06);
      --gridB: rgba(0,0,0,.03);

      --glowA: rgba(0,0,0,.15);
      --glowB: rgba(0,0,0,.08);
    }

    /* Dark mode (default) */
    html[data-theme="dark"]{
      --ink:#eef2ff;

      --bg1:#5a2bff;
      --bg2:#00e5ff;
      --bg3:#ffcc00;
      --bg4:#00ff9a;

      --card: rgba(20, 24, 40, .70);
      --key: rgba(255,255,255,.10);

      --shadow: 0 18px 55px rgba(0,0,0,.45);
      --keyShadow: 0 10px 18px rgba(0,0,0,.38);

      --keyPressed: rgba(255, 213, 79, .92);
      --muted:#eef2ffcc;

      --gridA: rgba(255,255,255,.08);
      --gridB: rgba(255,255,255,.04);

      --glowA: rgba(0, 255, 213, .26);
      --glowB: rgba(255, 0, 214, .18);
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: ui-rounded, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color: var(--ink);
      background: #060819;
      overflow:hidden;
      touch-action: manipulation;
      -webkit-text-size-adjust: 100%;
      text-size-adjust: 100%;
    }

    /* Animated background layers */
    .bg{
      position:fixed;
      inset:0;
      z-index:-3;
      overflow:hidden;
      background:
        radial-gradient(1200px 800px at 15% 20%, var(--bg2), transparent 60%),
        radial-gradient(1100px 750px at 80% 15%, var(--bg3), transparent 55%),
        radial-gradient(1200px 800px at 30% 85%, var(--bg4), transparent 60%),
        radial-gradient(1400px 900px at 85% 80%, var(--bg1), transparent 60%),
        #050616;
      animation: hue 14s linear infinite;
      will-change: filter;
    }

    .bgGrid{
      position:fixed;
      inset:-40px;
      z-index:-2;
      opacity:.52;
      background-image:
        linear-gradient(var(--gridA) 1px, transparent 1px),
        linear-gradient(90deg, var(--gridB) 1px, transparent 1px);
      background-size: 48px 48px;
      animation: drift 18s linear infinite;
      pointer-events:none;
    }

    .bgBubbles{
      position:fixed;
      inset:0;
      z-index:-1;
      pointer-events:none;
      filter: blur(.2px);
    }

    .bubble{
      position:absolute;
      width: var(--s);
      height: var(--s);
      border-radius: 999px;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.55), rgba(255,255,255,0) 55%);
      box-shadow:
        0 0 22px var(--glowA),
        0 0 42px var(--glowB);
      opacity:.55;
      animation: floaty var(--d) linear infinite;
    }

    @keyframes hue{
      0%{ filter: hue-rotate(0deg) saturate(1.05); }
      100%{ filter: hue-rotate(360deg) saturate(1.05); }
    }

    @keyframes drift{
      0%{ transform: translate3d(0,0,0) rotate(0deg); }
      100%{ transform: translate3d(-60px, 40px, 0) rotate(6deg); }
    }

    @keyframes floaty{
      0%{
        transform: translate3d(var(--x), calc(100vh + 120px), 0) scale(1);
        opacity: 0;
      }
      10%{ opacity: .55; }
      50%{ opacity: .7; }
      100%{
        transform: translate3d(calc(var(--x) + var(--dx)), -220px, 0) scale(.92);
        opacity: 0;
      }
    }

    .wrap{
      min-height: 100svh;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:space-between;
      padding: 18px;
      padding-top: calc(12px + env(safe-area-inset-top));
      padding-bottom: calc(16px + env(safe-area-inset-bottom));
      gap: 10px;
    }

    header{
      width: min(980px, 96vw);
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 10px;
      user-select:none;
    }

    .title{
      display:flex;
      flex-direction:column;
      gap: 6px;
      min-width: 200px;
    }
    .title h1{
      margin:0;
      font-size: clamp(16px, 2.3vw, 24px);
      letter-spacing: .2px;
      line-height: 1.1;
    }
    .title .hint{
      font-size: clamp(12px, 1.8vw, 14px);
      color: var(--muted);
      font-weight: 700;
    }

    .controls{
      display:flex;
      align-items:center;
      gap: 8px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    .pill{
      border:0;
      border-radius:999px;
      padding: 8px 12px;
      background: rgba(255,255,255,.10);
      color: var(--ink);
      box-shadow: 0 10px 20px rgba(0,0,0,.22);
      cursor:pointer;
      font-weight:800;
      font-size: 13px;
      user-select:none;
      transition: transform 120ms ease, background 200ms ease, opacity 200ms ease;
      backdrop-filter: blur(10px);
      -webkit-tap-highlight-color: transparent;
      white-space: nowrap;
    }
    html[data-theme="light"] .pill{
      background: #ffffffcc;
      box-shadow: 0 10px 20px rgba(0,0,0,.10);
      backdrop-filter: none;
    }
    .pill:active{ transform: scale(.98); }

    main{
      width: min(980px, 96vw);
      display:grid;
      grid-template-columns: 1fr;
      grid-template-rows: minmax(0, 1fr) auto;
      gap: 10px;
      align-items:stretch;
      flex: 1 1 auto;
      min-height: 0;
    }

    .card{
      position:relative;
      background: var(--card);
      border-radius: 26px;
      box-shadow: var(--shadow);
      padding: 14px;
      overflow:hidden;
      display:flex;
      flex-direction:column;
      justify-content:center;
      align-items:center;
      text-align:center;
      user-select:none;
      backdrop-filter: blur(12px);
      min-height: 0;
    }
    html[data-theme="light"] .card{ backdrop-filter:none; }

    .big{
      font-size: clamp(120px, 18vw, 240px);
      line-height: .95;
      margin: 0;
      letter-spacing: 2px;
      text-shadow: 0 12px 0 rgba(0,0,0,.18);
      animation: pop 650ms ease;
      -webkit-tap-highlight-color: transparent;
    }
    html[data-theme="light"] .big{
      text-shadow: 0 10px 0 rgba(0,0,0,.07);
    }

    .sub{
      margin: 10px 0 0;
      font-size: clamp(16px, 2.6vw, 28px);
      font-weight: 900;
    }

    .phrase{
      margin: 8px 0 0;
      font-size: clamp(12px, 1.8vw, 16px);
      color: var(--muted);
      font-weight:800;
      min-height: 1.2em;
    }

    .spark{
      position:absolute;
      inset:-30px;
      pointer-events:none;
      opacity:.98;
    }

    .floaty{
      position:absolute;
      width: 14px;
      height: 14px;
      border-radius: 999px;
      filter: blur(.2px);
      opacity: .9;
      animation: confettiUp 900ms ease-out forwards;
    }

    @keyframes pop{
      0%{ transform: scale(.7) rotate(-2deg); opacity:.25; }
      60%{ transform: scale(1.08) rotate(2deg); opacity:1; }
      100%{ transform: scale(1) rotate(0deg); }
    }

    @keyframes confettiUp{
      0%{ transform: translate(var(--x), var(--y)) scale(1); opacity: .95; }
      100%{ transform: translate(calc(var(--x) * 2.2), calc(var(--y) * 2.2 - 170px)) scale(.6); opacity: 0; }
    }

    .keyboard{
      background: var(--card);
      border-radius: 26px;
      box-shadow: var(--shadow);
      padding: 12px;
      display:flex;
      flex-direction:column;
      gap: 8px;
      user-select:none;
      backdrop-filter: blur(12px);
      min-height: 0;
    }
    html[data-theme="light"] .keyboard{ backdrop-filter:none; }

    .row{
      display:flex;
      gap: 6px;
      justify-content:center;
      flex-wrap:nowrap;
    }

    .key{
      flex: 0 0 auto;
      width: 50px;
      height: 48px;
      border-radius: 14px;
      background: var(--key);
      box-shadow: var(--keyShadow);
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight: 900;
      font-size: 17px;
      letter-spacing: .4px;
      transition: transform 90ms ease, background 120ms ease, box-shadow 120ms ease, color 120ms ease;
      color: var(--ink);
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
      user-select:none;
    }

    html[data-theme="dark"] .key{
      outline: 1px solid rgba(255,255,255,.08);
    }

    .key:active{ transform: translateY(1px) scale(1.02); }

    .key.pressed{
      background: var(--keyPressed);
      transform: translateY(1px) scale(1.03);
      box-shadow: 0 6px 16px rgba(0,0,0,.30);
      outline: 3px solid rgba(255,255,255,.12);
      color: #0b1020;
    }

    .wider{
      width: 280px;
      max-width: 100%;
      height: 50px;
    }

    footer{
      width:min(980px, 96vw);
      display:flex;
      align-items:center;
      justify-content:center;
      gap: 10px;
      flex-wrap:wrap;
      opacity: .92;
      font-size: 12px;
      user-select:none;
    }

    .badge{
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.10);
      box-shadow: 0 10px 20px rgba(0,0,0,.22);
      font-weight: 800;
      color: var(--ink);
      backdrop-filter: blur(10px);
    }
    html[data-theme="light"] .badge{
      background: #ffffffbb;
      box-shadow: 0 10px 20px rgba(0,0,0,.08);
      backdrop-filter:none;
    }

    .shake{ animation: shake 240ms ease; }
    @keyframes shake{
      0%{ transform: translateX(0); }
      25%{ transform: translateX(-6px); }
      50%{ transform: translateX(6px); }
      75%{ transform: translateX(-4px); }
      100%{ transform: translateX(0); }
    }

    /* iPhone-friendly: fit everything without looking zoomed */
    @media (max-width: 520px){
      .wrap{
        padding: 12px;
        padding-top: calc(10px + env(safe-area-inset-top));
        padding-bottom: calc(12px + env(safe-area-inset-bottom));
        gap: 10px;
      }

      header, main, footer{ width: 100%; }

      .title{ min-width: 0; }

      .pill{
        padding: 8px 10px;
        font-size: 12px;
      }

      main{
        grid-template-rows: minmax(0, 0.42fr) minmax(0, 0.58fr);
        gap: 10px;
      }

      .card{
        border-radius: 22px;
        padding: 12px;
      }

      .big{
        font-size: clamp(108px, 30vw, 190px);
      }

      .sub{
        font-size: clamp(16px, 4.8vw, 24px);
      }

      .keyboard{
        border-radius: 22px;
        padding: 12px;
        gap: 8px;
      }

      .row{
        gap: 6px;
        justify-content:center;
      }

      .key{
        width: 32px;
        height: 48px;
        border-radius: 14px;
        font-size: 16px;
      }

      /* Keyboard stagger like a real layout */
      #row2{ padding-left: 10px; }
      #row3{ padding-left: 22px; }

      .wider{
        width: min(300px, 90vw);
        height: 50px;
        font-size: 16px;
      }
    }

    @media (min-width: 521px) and (max-width: 720px){
      header, main, footer{ width: 100%; }
      .key{ width: 42px; }
      .wider{ width: min(340px, 92vw); }
      #row2{ padding-left: 10px; }
      #row3{ padding-left: 18px; }
    }
  </style>
</head>
<body>
  <div class="bg" aria-hidden="true"></div>
  <div class="bgGrid" aria-hidden="true"></div>
  <div class="bgBubbles" id="bgBubbles" aria-hidden="true"></div>

  <div class="wrap">
    <header>
      <div class="title">
        <h1>Little Typist ABC</h1>
        <div class="hint">Tap letters, numbers, or use a keyboard</div>
      </div>
      <div class="controls">
        <button id="themeBtn" class="pill" type="button" aria-pressed="true">Theme: Dark</button>
        <button id="voiceBtn" class="pill" type="button" aria-pressed="true">Voice: ON</button>
        <button id="soundBtn" class="pill" type="button" aria-pressed="true">Beep: ON</button>
        <button id="fullBtn" class="pill" type="button">Fullscreen</button>
        <button id="resetBtn" class="pill" type="button">Reset</button>
      </div>
    </header>

    <main>
      <section class="card" id="card" aria-live="polite">
        <div class="spark" id="spark"></div>
        <p class="big" id="big" title="(shh‚Ä¶ there is a secret)">A</p>
        <div class="sub" id="sub">Apple üçé</div>
        <div class="phrase" id="phrase">Press or tap a key!</div>
      </section>

      <aside class="keyboard" aria-label="On-screen keys">
        <div class="row" id="rowNums"></div>
        <div class="row" id="row1"></div>
        <div class="row" id="row2"></div>
        <div class="row" id="row3"></div>
        <div class="row" id="rowSpace"></div>
      </aside>
    </main>

    <footer>
      <div class="badge">If voice is silent, tap once to allow audio</div>
    </footer>
  </div>

  <script>
    // Default theme: dark
    const htmlEl = document.documentElement;
    htmlEl.setAttribute("data-theme", "dark");

    const letterMap = {
      A: "Apple üçé",  B: "Ball üèÄ",      C: "Cat üê±",      D: "Dog üê∂",
      E: "Elephant üêò", F: "Fish üêü",    G: "Grapes üçá",   H: "House üè†",
      I: "Ice cream üç¶", J: "Jelly ü´ô",  K: "Kite ü™Å",     L: "Lion ü¶Å",
      M: "Moon üåô",   N: "Nest ü™∫",      O: "Orange üçä",   P: "Pizza üçï",
      Q: "Queen üëë",  R: "Rainbow üåà",   S: "Sun ‚òÄÔ∏è",      T: "Tree üå≥",
      U: "Umbrella ‚òî", V: "Violin üéª",  W: "Whale üê≥",    X: "Xylophone üé∂",
      Y: "Yogurt üç®", Z: "Zebra ü¶ì"
    };

    const cheerPhrases = [
      "Yay!", "Nice!", "Good job!", "Again!", "Woohoo!", "Great pressing!", "You found it!"
    ];

    const big = document.getElementById("big");
    const sub = document.getElementById("sub");
    const phrase = document.getElementById("phrase");
    const spark = document.getElementById("spark");
    const card = document.getElementById("card");

    const themeBtn = document.getElementById("themeBtn");
    const voiceBtn = document.getElementById("voiceBtn");
    const soundBtn = document.getElementById("soundBtn");
    const fullBtn = document.getElementById("fullBtn");
    const resetBtn = document.getElementById("resetBtn");

    let voiceOn = true;
    let beepOn = true;

    // iOS/Safari: only speak after first user interaction
    let audioUnlocked = false;

    function unlockAudioOnce(){
      audioUnlocked = true;
      if (beepOn) ensureAudio();
      if ("speechSynthesis" in window) window.speechSynthesis.getVoices();
    }

    window.addEventListener("pointerdown", unlockAudioOnce, { once: true });

    function tinyVibrate(){
      if ("vibrate" in navigator) navigator.vibrate(12);
    }

    // Speech helpers
    function getPreferredVoice(){
      if (!("speechSynthesis" in window)) return null;
      const voices = window.speechSynthesis.getVoices() || [];
      return (
        voices.find(v => /en-GB/i.test(v.lang)) ||
        voices.find(v => /^en/i.test(v.lang)) ||
        voices[0] ||
        null
      );
    }

    function speak(text){
      if (!voiceOn) return;
      if (!("speechSynthesis" in window)) return;

      // Helps iOS: do not attempt before user gesture
      if (!audioUnlocked) return;

      try{
        window.speechSynthesis.cancel();

        const u = new SpeechSynthesisUtterance(text);
        u.lang = "en-GB";
        u.rate = 0.95;
        u.pitch = 1.1;
        u.volume = 1;

        const v = getPreferredVoice();
        if (v) u.voice = v;

        window.speechSynthesis.speak(u);
      } catch {
        // If speech fails, silently skip
      }
    }

    // IMPORTANT: for macOS "capital A" issue, speak "A." (not "A")
    function speechForKey(char){
      if (/^[A-Z]$/.test(char)) return `${char}.`;
      if (/^[0-9]$/.test(char)) return `${char}.`;
      if (char === "SPACE") return "space";
      return "";
    }

    window.speechSynthesis?.addEventListener?.("voiceschanged", () => {
      window.speechSynthesis.getVoices();
    });

    // Beep
    let audioCtx = null;
    function ensureAudio(){
      if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      if (audioCtx.state === "suspended") audioCtx.resume().catch(()=>{});
    }

    function beepFor(char){
      if (!beepOn) return;
      ensureAudio();

      let freq = 240;
      if (/^[A-Z]$/.test(char)){
        const n = char.charCodeAt(0) - 65;
        freq = 260 + (n * 18);
      } else if (/^[0-9]$/.test(char)){
        const n = Number(char);
        freq = 240 + (n * 35);
      } else if (char === "SPACE"){
        freq = 180;
      }

      const t = audioCtx.currentTime;
      const o = audioCtx.createOscillator();
      const g = audioCtx.createGain();

      o.type = "triangle";
      o.frequency.setValueAtTime(freq, t);

      g.gain.setValueAtTime(0.0001, t);
      g.gain.exponentialRampToValueAtTime(0.16, t + 0.02);
      g.gain.exponentialRampToValueAtTime(0.0001, t + 0.20);

      o.connect(g);
      g.connect(audioCtx.destination);
      o.start(t);
      o.stop(t + 0.22);
    }

    // Confetti burst
    function burst(extra=false){
      spark.innerHTML = "";
      const count = extra ? 46 : 22;
      const rect = card.getBoundingClientRect();
      const cx = rect.width / 2;
      const cy = rect.height / 2;

      for (let i = 0; i < count; i++){
        const dot = document.createElement("div");
        dot.className = "floaty";

        const angle = (Math.PI * 2) * (i / count) + (Math.random() * 0.35);
        const dist = (extra ? 18 : 10) + Math.random() * (extra ? 46 : 28);

        const x = Math.cos(angle) * dist;
        const y = Math.sin(angle) * dist;

        dot.style.left = (cx + (Math.random()*22 - 11)) + "px";
        dot.style.top  = (cy + (Math.random()*22 - 11)) + "px";
        dot.style.setProperty("--x", x + "px");
        dot.style.setProperty("--y", y + "px");

        dot.style.background = `hsl(${Math.floor(Math.random()*360)} 95% 65%)`;
        dot.style.width = (10 + Math.random()*(extra ? 14 : 12)) + "px";
        dot.style.height = dot.style.width;

        spark.appendChild(dot);
      }
    }

    // Background bubbles
    const bgBubbles = document.getElementById("bgBubbles");
    function randomBetween(a,b){ return a + Math.random()*(b-a); }

    function spawnBubble(){
      const b = document.createElement("div");
      b.className = "bubble";

      const size = Math.floor(randomBetween(40, 130));
      const x = Math.floor(randomBetween(0, window.innerWidth));
      const dx = Math.floor(randomBetween(-140, 140));
      const d = randomBetween(7, 14).toFixed(2) + "s";

      b.style.setProperty("--s", size + "px");
      b.style.setProperty("--x", x + "px");
      b.style.setProperty("--dx", dx + "px");
      b.style.setProperty("--d", d);

      bgBubbles.appendChild(b);

      const ms = parseFloat(d) * 1000 + 400;
      setTimeout(() => b.remove(), ms);
    }

    (function startBubbles(){
      for (let i=0;i<9;i++) spawnBubble();
      setInterval(() => {
        const count = bgBubbles.childElementCount;
        const want = 12;
        if (count < want) spawnBubble();
        else if (Math.random() < 0.35) spawnBubble();
      }, 700);
    })();

    // On-screen keyboard
    const layout = {
      nums: ["1","2","3","4","5","6","7","8","9","0"],
      r1: ["Q","W","E","R","T","Y","U","I","O","P"],
      r2: ["A","S","D","F","G","H","J","K","L"],
      r3: ["Z","X","C","V","B","N","M"],
      space: ["SPACE"]
    };

    const keyEls = new Map();
    let lastPressedEl = null;
    let clearTimer = null;

    function highlightKey(k){
      if (lastPressedEl) lastPressedEl.classList.remove("pressed");
      const el = keyEls.get(k);
      if (el){
        el.classList.add("pressed");
        lastPressedEl = el;
      } else {
        lastPressedEl = null;
      }

      if (clearTimer) clearTimeout(clearTimer);
      clearTimer = setTimeout(() => {
        if (lastPressedEl) lastPressedEl.classList.remove("pressed");
        lastPressedEl = null;
      }, 650);
    }

    function showChar(char){
      big.style.animation = "none";
      void big.offsetWidth;
      big.style.animation = "";

      big.textContent = char;

      if (/^[A-Z]$/.test(char)){
        sub.textContent = letterMap[char] || "";
      } else if (/^[0-9]$/.test(char)){
        const n = Number(char);
        const stars = "‚≠ê".repeat(Math.max(1, n === 0 ? 1 : Math.min(n, 10)));
        sub.textContent = `Number ${char} ${stars}`;
      } else if (char === "SPACE"){
        sub.textContent = "Big space! ‚òÅÔ∏è";
      } else {
        sub.textContent = "";
      }

      phrase.textContent = cheerPhrases[Math.floor(Math.random() * cheerPhrases.length)];
      burst(false);
      tinyVibrate();

      beepFor(char);

      const say = speechForKey(char);
      if (say) speak(say);
    }

    function pressKey(label){
      highlightKey(label);
      showChar(label);
    }

    function makeKey(label){
      const el = document.createElement("div");
      el.className = "key";
      el.dataset.key = label;
      el.setAttribute("role", "button");
      el.setAttribute("tabindex", "0");
      el.setAttribute("aria-label", label === "SPACE" ? "Space" : label);

      if (label === "SPACE"){
        el.classList.add("wider");
        el.textContent = "SPACE";
      } else {
        el.textContent = label;
      }

      el.addEventListener("pointerdown", (e) => {
        e.preventDefault();
        pressKey(label);
      });

      el.addEventListener("keydown", (e) => {
        if (e.key === "Enter" || e.key === " "){
          e.preventDefault();
          pressKey(label);
        }
      });

      return el;
    }

    function buildKeyboard(){
      const rowNums = document.getElementById("rowNums");
      const row1 = document.getElementById("row1");
      const row2 = document.getElementById("row2");
      const row3 = document.getElementById("row3");
      const rowSpace = document.getElementById("rowSpace");
      [rowNums,row1,row2,row3,rowSpace].forEach(r => r.innerHTML = "");

      function addRow(container, keys){
        keys.forEach(k => {
          const el = makeKey(k);
          container.appendChild(el);
          keyEls.set(k, el);
        });
      }

      addRow(rowNums, layout.nums);
      addRow(row1, layout.r1);
      addRow(row2, layout.r2);
      addRow(row3, layout.r3);

      const spaceEl = makeKey("SPACE");
      rowSpace.appendChild(spaceEl);
      keyEls.set("SPACE", spaceEl);
    }

    buildKeyboard();

    // Physical keyboard support
    function handleKeydown(e){
      if (e.repeat) return;

      const k = e.key;

      if (k === " " || k === "Spacebar"){
        e.preventDefault();
        pressKey("SPACE");
        return;
      }

      if (/^[a-zA-Z]$/.test(k)){
        pressKey(k.toUpperCase());
        return;
      }

      if (/^[0-9]$/.test(k)){
        pressKey(k);
        return;
      }

      card.classList.remove("shake");
      void card.offsetWidth;
      card.classList.add("shake");
      phrase.textContent = "Try A to Z or 0 to 9";
    }

    window.addEventListener("keydown", handleKeydown, { passive: false });

    // Controls
    function updateButtons(){
      const theme = htmlEl.getAttribute("data-theme");
      themeBtn.textContent = `Theme: ${theme === "dark" ? "Dark" : "Light"}`;
      voiceBtn.textContent = `Voice: ${voiceOn ? "ON" : "OFF"}`;
      soundBtn.textContent = `Beep: ${beepOn ? "ON" : "OFF"}`;
      themeBtn.setAttribute("aria-pressed", String(theme === "dark"));
      voiceBtn.setAttribute("aria-pressed", String(voiceOn));
      soundBtn.setAttribute("aria-pressed", String(beepOn));
    }

    themeBtn.addEventListener("click", () => {
      const now = htmlEl.getAttribute("data-theme") === "dark" ? "light" : "dark";
      htmlEl.setAttribute("data-theme", now);
      updateButtons();
    });

    voiceBtn.addEventListener("click", () => {
      voiceOn = !voiceOn;
      updateButtons();
      if (voiceOn && "speechSynthesis" in window) window.speechSynthesis.getVoices();
    });

    soundBtn.addEventListener("click", () => {
      beepOn = !beepOn;
      updateButtons();
      if (beepOn) ensureAudio();
    });

    fullBtn.addEventListener("click", async () => {
      try{
        if (!document.fullscreenElement){
          await document.documentElement.requestFullscreen();
          fullBtn.textContent = "Exit fullscreen";
        } else {
          await document.exitFullscreen();
          fullBtn.textContent = "Fullscreen";
        }
      } catch {
        phrase.textContent = "Fullscreen may be blocked";
      }
    });

    document.addEventListener("fullscreenchange", () => {
      fullBtn.textContent = document.fullscreenElement ? "Exit fullscreen" : "Fullscreen";
    });

    resetBtn.addEventListener("click", () => {
      big.textContent = "A";
      sub.textContent = "Apple üçé";
      phrase.textContent = "Press or tap a key!";
      if (lastPressedEl) lastPressedEl.classList.remove("pressed");
      lastPressedEl = null;
      spark.innerHTML = "";
      window.speechSynthesis?.cancel?.();
    });

    // Tiny secret (no on-screen hint): tap the big letter 7 times quickly
    let tapCount = 0;
    let tapTimer = null;
    big.addEventListener("pointerdown", () => {
      tapCount += 1;
      if (tapTimer) clearTimeout(tapTimer);
      tapTimer = setTimeout(() => { tapCount = 0; }, 650);

      if (tapCount >= 7){
        tapCount = 0;
        phrase.textContent = "Secret sparkle!";
        burst(true);
        const say = "Yay!";
        speak(say);
        tinyVibrate();
      }
    });

    updateButtons();
  </script>
</body>
</html>
